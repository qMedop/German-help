<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>German Study App - PDF Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .nav-btn {
        @apply py-3 px-6 text-lg font-medium text-slate-400 rounded-t-lg border-b-4 border-transparent hover:text-sky-400 hover:border-sky-400 transition-all duration-300;
      }
      .nav-btn-active {
        @apply text-sky-500 border-sky-500;
      }
    </style>
  </head>
  <body
    class="bg-slate-900 text-slate-200 flex items-center justify-center min-h-screen p-4"
  >
    <div
      class="w-full max-w-4xl bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 space-y-6"
    >
      <!-- === NAVIGATION === -->
      <nav class="flex border-b-2 border-slate-700">
        <button class="nav-btn nav-btn-active">PDF Generator</button>
        <a href="test.html" class="nav-btn">Test Yourself</a>
      </nav>

      <!-- === PDF GENERATOR PAGE === -->
      <div id="page-generator">
        <p class="text-center text-slate-400 -mt-4 mb-6">
          Create, save, and print your vocabulary lists.
        </p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Left Column -->
          <div class="space-y-4">
            <div>
              <label
                for="lessonId"
                class="block text-sm font-medium text-slate-300 mb-2"
                >Lesson ID (e.g., "3"):</label
              >
              <input
                type="text"
                id="lessonId"
                class="w-full p-3 bg-slate-700 border border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 text-slate-200"
                placeholder="Required to save/overwrite data"
              />
            </div>
            <div>
              <label
                for="pdfTitle"
                class="block text-sm font-medium text-slate-300 mb-2"
                >PDF Title:</label
              >
              <input
                type="text"
                id="pdfTitle"
                class="w-full p-3 bg-slate-700 border border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 text-slate-200"
                placeholder="e.g., Lektion 3: Verben"
              />
            </div>
            <div>
              <label
                for="jsonData"
                class="block text-sm font-medium text-slate-300 mb-2"
                >Vocabulary Data (JSON):</label
              >
              <textarea
                id="jsonData"
                rows="10"
                class="w-full p-3 bg-slate-700 border border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 text-slate-200 placeholder-slate-500 transition duration-200"
                placeholder="Paste your JSON array here..."
              ></textarea>
            </div>
          </div>
          <!-- Right Column -->
          <div>
            <label
              for="pdfNotes"
              class="block text-sm font-medium text-slate-300 mb-2"
              >General Notes:</label
            >
            <textarea
              id="pdfNotes"
              rows="20"
              class="w-full h-[calc(100%-24px)] p-3 bg-slate-700 border border-slate-600 rounded-md focus:ring-2 focus:ring-sky-500 text-slate-200 placeholder-slate-500"
              placeholder="Add any general notes, reminders, or grammar rules here."
            ></textarea>
          </div>
        </div>

        <!-- Action Button and Status -->
        <div class="flex flex-col items-center pt-4">
          <button
            id="generatePdfBtn"
            class="w-full md:w-auto bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-8 rounded-lg transition-transform transform hover:scale-105 duration-300 shadow-lg"
          >
            Generate PDF & Save Lesson
          </button>
          <p id="statusMessage" class="mt-4 h-5 text-sm"></p>
        </div>
      </div>
    </div>

    <script>
      const LOCAL_STORAGE_PREFIX = "vocab-list-";

      function generateVocabularyPDF(title, notes, vocabularyData) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let startY = 22;

        if (title) {
          doc.setFontSize(18);
          doc.setTextColor(0, 0, 0);
          doc.text(title, doc.internal.pageSize.getWidth() / 2, startY, {
            align: "center",
          });
          startY += 12;
        }

        const tableHead = [["Geschlecht", "Wort", "Aussprache", "Übersetzung"]];
        const tableBody = vocabularyData.map((item) => {
          const wordCell =
            item.tip && item.tip.trim() ? `* ${item.word}` : item.word;
          return [
            item.gender || "-",
            wordCell || "",
            item.pronunciation || "",
            item.translation || "",
          ];
        });

        doc.autoTable({
          head: tableHead,
          body: tableBody,
          startY: startY,
          headStyles: { fillColor: [14, 116, 144], textColor: [255, 255, 255] },
          styles: { font: "helvetica", fontSize: 10 },
        });

        const tips = vocabularyData
          .filter((item) => item.tip && item.tip.trim())
          .map((item) => `* ${item.word}: ${item.tip.trim()}`);

        let notesContent = "";
        if (tips.length > 0) notesContent += tips.join("\n");
        if (notes) notesContent += (tips.length > 0 ? "\n\n" : "") + notes;

        if (notesContent.trim()) {
          let notesStartY = doc.lastAutoTable.finalY + 10;
          if (notesStartY > doc.internal.pageSize.getHeight() - 30) {
            doc.addPage();
            notesStartY = 22;
          }
          doc.setFontSize(14);
          doc.text("Notes & Tips", 14, notesStartY);
          notesStartY += 8;
          doc.setFontSize(10);
          const splitNotes = doc.splitTextToSize(notesContent, 180);
          doc.text(splitNotes, 14, notesStartY);
        }

        return doc;
      }

      function handleGeneratePdf() {
        const statusMessageEl = document.getElementById("statusMessage");
        statusMessageEl.textContent = "";
        const lessonId = document.getElementById("lessonId").value.trim();
        const title = document.getElementById("pdfTitle").value.trim();
        const notes = document.getElementById("pdfNotes").value.trim();
        const rawData = document.getElementById("jsonData").value;

        if (!lessonId)
          return (statusMessageEl.textContent =
            "Error: Lesson ID is required.");
        if (!rawData.trim())
          return (statusMessageEl.textContent =
            "Error: Vocabulary data cannot be empty.");

        let vocabularyData;
        try {
          vocabularyData = JSON.parse(rawData);
        } catch {
          return (statusMessageEl.textContent = "Error: Invalid JSON format.");
        }

        try {
          localStorage.setItem(LOCAL_STORAGE_PREFIX + lessonId, rawData);
          const doc = generateVocabularyPDF(title, notes, vocabularyData);
          doc.save((title || `lektion_${lessonId}`) + ".pdf");
          statusMessageEl.textContent = `✅ PDF generated and Lektion ${lessonId} saved!`;
          statusMessageEl.classList.add("text-green-400");
        } catch {
          statusMessageEl.textContent = "Error: Could not save.";
        }
      }

      document
        .getElementById("generatePdfBtn")
        .addEventListener("click", handleGeneratePdf);

      // Sample Data
      const sampleData = [
        {
          gender: "die",
          word: "Straße",
          pronunciation: "/Shtra-seh/",
          translation: "Street",
        },
        {
          gender: "die",
          word: "Stadt",
          pronunciation: "/Shtat/",
          translation: "City",
          tip: "All nouns in German are capitalized.",
        },
        {
          gender: "der",
          word: "Mann",
          pronunciation: "/Mahn/",
          translation: "Man",
        },
      ];
      document.getElementById("jsonData").value = JSON.stringify(
        sampleData,
        null,
        2
      );
      document.getElementById("lessonId").value = "1";
      document.getElementById("pdfTitle").value = "Lektion 1: Beispiel";
    </script>
  </body>
</html>
